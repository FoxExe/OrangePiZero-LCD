#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>

#include <wiringPi.h>
#include "pcd8544.h"

#define MAX_BTN 4
#define PIN_UP 15
#define PIN_DOWN 16
#define PIN_LEFT 1
#define PIN_RIGHT 4

#define LCD_BACKLIGHT 0

const unsigned char FoxLogo[] = {
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0x70, 0x30, 0x18, 0x18,
	0xFC, 0xFC, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0x30,
	0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
	0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF8, 0xFE, 0xFF, 0xFF, 0xF0, 0xE0, 0xC0,
	0x8E, 0x1F, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFE, 0x0F, 0x03, 0x01, 0x00,
	0x80, 0x00, 0x00, 0x3F, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xFF, 0xFF, 0xFF, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x7C, 0xFF, 0xFF, 0xC3, 0x81,
	0x81, 0xC3, 0xFF, 0xFF, 0x3E, 0x00, 0x00, 0x00, 0xC1, 0xE7, 0x7F, 0x1C, 0x7C, 0xFF, 0xC3, 0x81,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F,
	0x3F, 0x3F, 0x3C, 0x3C, 0x3D, 0x3F, 0x1F, 0x1E, 0x0E, 0x06, 0x02, 0x00, 0x00, 0x00, 0x0F, 0x3F,
	0xF0, 0xC0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xFC, 0xFF, 0xFF, 0xF8, 0xE0, 0x80, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00,
	0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x1F,
	0xFF, 0xFF, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFE, 0xFC, 0xF8,
	0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xC1, 0xC3, 0x87, 0x0F, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0,
	0x60, 0x60, 0x60, 0xE0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0x60, 0x60, 0x60, 0x60,
	0x60, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x1C, 0x38, 0x70, 0x60, 0x00, 0x80, 0xE0, 0xFC,
	0xFF, 0x7F, 0x3F, 0x1F, 0x0F, 0x0F, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x00, 0x3F,
	0x7F, 0x7F, 0x3F, 0x1F, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x7F, 0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x83, 0x07, 0x0F,
	0x0E, 0x1C, 0x1C, 0x9C, 0xF8, 0xF8, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	0x3C, 0x0F, 0x03, 0x01, 0x08, 0x1C, 0x38, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01,
	0x7B, 0x1F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
	0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

enum
{
	KEY_UP,
	KEY_DOWN,
	KEY_LEFT,
	KEY_RIGHT
};

typedef struct Button
{
	short int pin;
	void (*OnPress)();
} Button;

typedef struct MenuItem
{
	char *Name;
	void (*Run)();
} MenuItem;

void DoNothing()
{
	// Do nothig (Dummy for buttons)
}

void PrintHello()
{
	// LCD.Clear();
	// LCD.Print("Hello, world!");
	printf("PrintHello()\n");
}

void PrintWelcome()
{
	printf("PrintWelcome()\n");
}

void PrintNetworkSettings()
{
	printf("PrintNetworkSettings()");
}

void PrintBackLightMenu()
{

	//digitalWrite(LCD_BACKLIGHT, LOW);	// ON
	//digitalWrite(LCD_BACKLIGHT, HIGH);	// OFF
}

void TurnBacklightOn()
{
	digitalWrite(LCD_BACKLIGHT, LOW);
}

void TurnBacklightOff()
{
	digitalWrite(LCD_BACKLIGHT, HIGH);
}

static MenuItem MainMenu[] = {
	{"1. First Option", DoNothing},
	{"2. Backlight", PrintBackLightMenu},
	{"3. Network", PrintNetworkSettings},
};

static MenuItem BackLightMenu[] = {
	{"Turn On", TurnBacklightOn},
	{"Turn Off", TurnBacklightOff},
};

static MenuItem NetworkSettingsMenu[] = {
	{"Option #1", DoNothing},
	{"Option #2", DoNothing},
	{"Option #3", DoNothing},
};

// Buttons default state
Button Buttons[MAX_BTN] = {
	{PIN_UP, DoNothing},
	{PIN_DOWN, DoNothing},
	{PIN_LEFT, DoNothing},
	{PIN_RIGHT, DoNothing},
};

void PrintMenuItems(MenuItem *items, int count, int selected)
{
	printf("PrintMenuItems()\n");

	LCDclear();
	for (int i = 0; i < count; i++)
	{
		LCDdrawstring(0, i * 8 + 1, items[i].Name);
		printf("%s\n", items[i].Name);
	}
	LCDdisplay();
}

void SelectCurrent()
{
	printf("SelectCurrent()\n");
}

void PrintMainMenu()
{
	PrintMenuItems(MainMenu, 3, 0);
	Buttons[KEY_RIGHT].OnPress = SelectCurrent;
	Buttons[KEY_LEFT].OnPress = DoNothing;
}

int main(int argc, char **argv)
{
	/*
        if (argc != 2) {
                printf("Usage:\n%s \"Some string\"\n", argv[0]);
                return 1;
        }
*/

	printf("Program started...\n");

	wiringPiSetup();
	//wiringPiSetupSys();

	// Turn on backlight
	// TODO: PWM mode for brighteness control
	pinMode(LCD_BACKLIGHT, OUTPUT);
	digitalWrite(LCD_BACKLIGHT, LOW);

	// LCD Init: CLK, DIN, DC, CS, RST, Contrast (Max: 127)
	LCDInit(2, 3, 12, 13, 14, 64);
	LCDshowLogo(FoxLogo);
	delay(5000);

	// Init buttons
	for (int i = 0; i < MAX_BTN; i++)
	{
		pinMode(Buttons[i].pin, INPUT);
	}

	PrintMainMenu();

	//CurrentFunction = MainMenu[1].Run();
	//CurrentFunction();
	// or
	//MainMenu[1].Run();
	/*
	while (1) {
		for (int i = 0; i < MAX_BTN; i++)
		{
			if (DigitalRead(Buttons[i].pin) == LOW) {
				// Wait some time for debounce
				delay(50);
				// Read again
				if (DigitalRead(Buttons[i].pin) == LOW) {
					// Still pressed, run function.
					Buttons[i].OnPress();
					// Do not run twice!
					Buttons[i].OnPress = DoNothing;
				}
			}
		}
	}
*/
	return 0;
}
